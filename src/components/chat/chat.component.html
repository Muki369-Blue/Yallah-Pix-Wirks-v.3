<div class="animate-fade-in flex flex-col h-[calc(100vh-250px)] sm:h-[calc(100vh-220px)]">
  <app-chatbot-face [mood]="botMood()"></app-chatbot-face>
  
  <div #chatContainer class="flex-grow overflow-y-auto bg-slate-800/50 p-4 rounded-2xl shadow-lg border border-slate-700 mb-4 space-y-4">
    @if (history().length === 0) {
      <div class="text-center text-slate-500 pt-8">Ask me anything!</div>
    }
    @for (msg of history(); track $index) {
      <div class="flex group" [class]="msg.role === 'user' ? 'justify-end' : 'justify-start'">
        <div class="max-w-xl p-3 rounded-lg relative" [class]="msg.role === 'user' ? 'bg-sky-600' : 'bg-slate-600'">
          @if(msg.role === 'model' && msg.parts[0].text !== '...') {
             <div class="prose prose-invert prose-sm" [innerHTML]="renderMarkdown(msg.parts[0].text)"></div>
             <button (click)="copyToClipboard(msg.parts[0].text)" class="absolute -top-2 -right-2 w-7 h-7 bg-slate-500 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
             </button>
          } @else {
             <p class="whitespace-pre-wrap">{{ msg.parts[0].text }}</p>
          }
        </div>
      </div>
    }
    @if (error()) {
      <app-error-display [message]="error()!"></app-error-display>
    }
  </div>

  <div class="relative">
    @if (history().length > 0 && !loading()) {
       <button (click)="clearHistory()" title="Clear Conversation" class="absolute top-1/2 left-3 -translate-y-1/2 text-slate-400 hover:text-white">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11"x2="14" y2="17"></line></svg>
       </button>
    }
    <input 
      type="text" 
      [value]="userInput()" 
      (input)="userInput.set($any($event.target).value)" 
      (keypress)="$event.key === 'Enter' && !loading() && handleSend()" 
      placeholder="Type your message..." 
      class="w-full p-4 pl-12 pr-14 bg-slate-700 rounded-lg border-2 border-slate-600 focus:border-green-500 transition-colors" 
    />
    <button (click)="handleSend()" [disabled]="loading()" class="absolute top-1/2 right-3 -translate-y-1/2 text-green-400 disabled:text-slate-500">
        @if(loading()) {
            <div class="w-6 h-6 border-2 border-dashed rounded-full animate-spin border-white"></div>
        } @else {
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
        }
    </button>
  </div>
</div>
